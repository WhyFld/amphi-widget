<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AMPHI Widget</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: transparent;
    }

    .glass-popup {
      background: rgba(0, 0, 0, 0.40);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: 
        0 8px 32px 0 rgba(0, 0, 0, 0.15),
        inset 0 1px 0 0 rgba(255, 255, 255, 0.2);
    }

    .glass-popup h2,
    .glass-popup p {
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .campaign-area {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .popup-enter {
      animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideInFromRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideInFromLeft {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .slide-right {
      animation: slideInFromRight 0.3s ease-out;
    }

    .slide-left {
      animation: slideInFromLeft 0.3s ease-out;
    }

    .carousel-dot {
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .carousel-dot.active {
      background: #CCFF66;
      width: 24px;
      border-radius: 4px;
      box-shadow: 0 2px 12px rgba(204, 255, 102, 0.5);
    }

    .arrow-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.25);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 30;
    }

    .arrow-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-50%) scale(1.05);
    }

    .arrow-btn.left {
      left: 8px;
    }

    .arrow-btn.right {
      right: 8px;
    }

    .poll-option {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      transition: all 0.2s;
    }
    .poll-option:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(204, 255, 102, 0.5);
    }
    .poll-option.selected {
      background: rgba(204, 255, 102, 0.2);
      border-color: #CCFF66;
    }

    textarea, input[type="text"], input[type="email"] {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      outline: none;
    }
    textarea:focus, input:focus {
      border-color: #CCFF66;
      background: rgba(255, 255, 255, 0.15);
    }
    textarea::placeholder, input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .loading {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
  </style>
</head>
<body>

<div id="widget-root" class="w-full h-screen flex items-center justify-center p-4">
  <div class="glass-popup popup-enter rounded-3xl w-full max-w-lg relative overflow-hidden" style="min-height: 520px;">
    
<button onclick="minimizeWidget()" class="absolute top-4 right-4 text-white/60 hover:text-white text-2xl font-bold w-8 h-8 flex items-center justify-center transition-all hover:scale-110 z-50">
  √ó
</button>

    <button id="backBtn" onclick="goBack()" class="absolute top-4 left-4 text-white/60 hover:text-white text-xl font-bold z-10 transition-colors hidden">
      ‚Üê Back
    </button>


    <div id="content" class="p-8 pt-12">
      <div class="text-center">
        <div class="text-4xl mb-4 loading">‚è≥</div>
        <p class="text-white/70">Loading campaigns...</p>
      </div>
    </div>

    <div class="text-center pb-4 text-white/30 text-xs">
      Powered by AMPHI
    </div>

  </div>
</div>

<div id="minimizedIcon" class="hidden fixed bottom-6 right-6 z-50 cursor-pointer group" onclick="restoreWidget()">
  <div class="relative">
    <!-- Icon Circle -->
    <div class="w-16 h-16 rounded-full bg-[#CCFF66] flex items-center justify-center shadow-2xl transform transition-all duration-300 group-hover:scale-110">
      <span class="text-3xl">üí¨</span>
    </div>
    <!-- Pulse Animation -->
    <div class="absolute inset-0 rounded-full bg-[#CCFF66] opacity-20 animate-ping"></div>
  </div>
</div>
  
<script>
// ============================================
// SUPABASE CONNECTION
// ============================================
const SUPABASE_URL = 'https://puhsbgrublugmqqgvmqd.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1aHNiZ3J1Ymx1Z21xcWd2bXFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTE5MjQsImV4cCI6MjA3NTU4NzkyNH0.tFzNj4RMmgxa2hm_nf0IR1dvedy2u3GST2LmjLeV6WE';
const BRAND_ID = '3c4b9a71-3aa4-4a9d-b17c-5bedf24b50c2'; // Your test brand

// Create Supabase client for storage uploads
const supabaseClient = {
  storage: {
    from: (bucket) => ({
      upload: async (path, file, options) => {
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch(
          `${SUPABASE_URL}/storage/v1/object/${bucket}/${path}`,
          {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            },
            body: file
          }
        );
        
        if (!response.ok) {
          const error = await response.json();
          return { data: null, error };
        }
        
        return { data: { path }, error: null };
      },
      getPublicUrl: (path) => ({
        publicUrl: `${SUPABASE_URL}/storage/v1/object/public/${bucket}/${path}`
      })
    })
  }
};

// Track completed campaigns in localStorage
function getCompletedCampaigns() {
  const completed = localStorage.getItem('amphi_completed_campaigns');
  return completed ? JSON.parse(completed) : [];
}

function markCampaignCompleted(campaignId) {
  const completed = getCompletedCampaigns();
  if (!completed.includes(campaignId)) {
    completed.push(campaignId);
    localStorage.setItem('amphi_completed_campaigns', JSON.stringify(completed));
  }
}

function isCampaignCompleted(campaignId) {
  return getCompletedCampaigns().includes(campaignId);
}


  
// ============================================
// STATE MANAGEMENT
// ============================================
let currentStep = 1;
let currentQuestionIndex = 0;
let formData = {};
let campaigns = [];

// ============================================
// FETCH CAMPAIGNS FROM SUPABASE
// ============================================
async function loadCampaigns() {
  try {
    const response = await fetch(
      `${SUPABASE_URL}/rest/v1/tasks?brand_id=eq.${BRAND_ID}&is_active=eq.true&select=*`,
      {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      }
    );

    const data = await response.json();
    
    if (!data || data.length === 0) {
      showError('No active campaigns found');
      return;
    }

    // Just take the first one
    const campaign = data[0];

    campaigns = [{
      id: campaign.id,
      title: campaign.title,
      description: campaign.description,
      type: campaign.task_type,
      reward: campaign.reward_amount,
      questions: campaign.required_fields || [],
      icon: campaign.task_type === 'poll' ? 'üìä' :
            campaign.task_type === 'text_feedback' ? 'üí¨' :
            campaign.task_type === 'video_upload' ? 'üé•' :
            campaign.task_type === 'audio_upload' ? 'üé§' :
            campaign.task_type === 'image_upload' ? 'üì∏' : 'üìÑ'
    }];

    console.log('Loaded single campaign:', campaigns[0]);

    // STRIPE RETURN: SHOW SUCCESS EVEN IF COMPLETED
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      const email = urlParams.get('email');
      console.log('Returning from Stripe ‚Äî showing success');

      await fetch(`${SUPABASE_URL}/rest/v1/customers?email=eq.${encodeURIComponent(email)}`, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          stripe_onboarding_completed: true
        })
      });

      showFinalSuccess();
      window.history.replaceState({}, '', window.location.pathname);
      return;
    }

    // NORMAL FLOW: Hide if already completed
    if (isCampaignCompleted(campaigns[0].id)) {
      console.log('User already completed ‚Äî hiding widget');
      document.getElementById('widget-root').style.display = 'none';
      document.getElementById('minimizedIcon').classList.add('hidden');
      return;
    }

    renderStep1();

  } catch (error) {
    console.error('‚ùå Failed to load campaigns:', error);
    showError('Failed to load campaigns');
  }
}

function getIconForType(type) {
  const icons = {
    'poll': 'üìä',
    'text_feedback': 'üí¨',
    'video_upload': 'üé•',
    'audio_upload': 'üé§',
    'image_upload': 'üì∏'
  };
  return icons[type] || 'üìã';
}

function showError(message) {
  document.getElementById('content').innerHTML = `
    <div class="text-center">
      <div class="text-4xl mb-4">‚ö†Ô∏è</div>
      <p class="text-white/70">${message}</p>
    </div>
  `;
}

// ============================================
// NAVIGATION
// ============================================
function goBack() {
  if (currentStep === 2) {
    currentStep = 1;
    currentQuestionIndex = 0;
    formData = {};
    renderStep1();
  }
}

function closeWidget() {
  minimizeWidget();
}


function startCampaign() {
  currentStep = 2;
  currentQuestionIndex = 0;
  formData = {};
  renderStep2();
}

// ============================================
// STEP 1: CAMPAIGN CAROUSEL
// ============================================
function renderStep1() {
  document.getElementById('backBtn').classList.add('hidden');
  
  const campaign = campaigns[0];
  
  let taskDetails = '';
  if (campaign.type === 'poll') {
    taskDetails = `${campaign.questions.length} quick questions`;
  } else if (campaign.type === 'text_feedback') {
    taskDetails = `${campaign.questions.length} text questions`;
  } else if (campaign.type === 'video_upload') {
    taskDetails = 'Record 90-second video';
  } else if (campaign.type === 'audio_upload') {
    taskDetails = 'Record 60-second audio';
  } else if (campaign.type === 'image_upload') {
    taskDetails = 'Upload 1 photo';
  }

  document.getElementById('content').innerHTML = `
    <h2 class="text-white text-2xl font-bold text-center mb-8">
      ${campaign.title} & earn ¬£${campaign.reward}
    </h2>

    <div class="campaign-area rounded-2xl p-8 mb-6 min-h-[280px] flex items-center justify-center">
      <div class="text-center">
        <div class="text-6xl mb-4">${campaign.icon}</div>
        <p class="text-white/80 text-lg font-semibold mb-2">${campaign.title}</p>
        <p class="text-white/50 text-sm mb-1">${campaign.description}</p>
        <p class="text-white/40 text-xs mt-2">${taskDetails}</p>
      </div>
    </div>


    <button onclick="startCampaign()" class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg">
      Start & Earn ¬£${campaign.reward} ‚Üí
    </button>
  `;
}

// ============================================
// STEP 2: CAMPAIGN FORM
// ============================================
function renderStep2() {
  document.getElementById('backBtn').classList.remove('hidden');
  
 const campaign = campaigns[0];

  if (campaign.type === 'poll') {
    renderPoll(campaign);
  } else if (campaign.type === 'text_feedback') {
    renderTextFeedback(campaign);
  } else if (campaign.type === 'video_upload') {
    renderVideoUpload(campaign);
  } else if (campaign.type === 'audio_upload') {
    renderAudioUpload(campaign);
  } else if (campaign.type === 'image_upload') {
    renderImageUpload(campaign);
  }
}

// POLL
function renderPoll(campaign) {
  const question = campaign.questions[currentQuestionIndex];
  const totalQuestions = campaign.questions.length;
  const isLastQuestion = currentQuestionIndex === totalQuestions - 1;

  document.getElementById('content').innerHTML = `
    <div class="text-center mb-4">
      <div class="text-white/50 text-sm mb-2">Question ${currentQuestionIndex + 1} of ${totalQuestions}</div>
      <h3 class="text-white text-xl font-bold">${question.question}</h3>
    </div>

    <div class="space-y-3 mb-6">
      ${question.options.map((option, i) => `
        <button onclick="selectPollOption(${i})" 
                id="poll-option-${i}"
                class="poll-option w-full py-4 px-6 rounded-xl text-white font-medium text-left">
          ${option}
        </button>
      `).join('')}
    </div>

    <button id="nextBtn" onclick="${isLastQuestion ? 'submitPoll()' : 'nextPollQuestion()'}" 
            class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg opacity-50 cursor-not-allowed" 
            disabled>
      ${isLastQuestion ? 'Submit & Get Paid ‚Üí' : 'Next Question ‚Üí'}
    </button>
  `;
}

function selectPollOption(index) {
  document.querySelectorAll('.poll-option').forEach(btn => {
    btn.classList.remove('selected');
  });
  
  document.getElementById(`poll-option-${index}`).classList.add('selected');
  
  const campaign = campaigns[0];
  const question = campaign.questions[currentQuestionIndex];
  formData[`question_${currentQuestionIndex}`] = {
    question: question.question,
    answer: question.options[index]
  };
  
  const nextBtn = document.getElementById('nextBtn');
  nextBtn.disabled = false;
  nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
}

function nextPollQuestion() {
  currentQuestionIndex++;
  renderStep2();
}

async function submitPoll() {
  console.log('üìä Submitting poll:', formData);
  
  const campaign = campaigns[0];
  
  // Build readable text content from poll answers
  let textContent = '';
  Object.values(formData).forEach((item, index) => {
    textContent += `Q${index + 1}: ${item.question}\nA: ${item.answer}\n\n`;
  });
  
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/submissions`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify({
        task_id: campaign.id,
        brand_id: BRAND_ID,
        submission_type: 'poll',
        text_content: textContent.trim(),
        survey_responses: formData,
        status: 'pending',
        customer_email: 'test@example.com'
      })
    });

    if (response.ok) {
      console.log('‚úÖ Poll submitted successfully!');
      renderStep3();
    } else {
      const error = await response.json();
      console.error('‚ùå Submission failed:', error);
      alert('Submission failed. Please try again.');
    }
  } catch (error) {
    console.error('‚ùå Submission error:', error);
    alert('Submission failed. Please try again.');
  }
}
// TEXT FEEDBACK
function renderTextFeedback(campaign) {
  const question = campaign.questions[currentQuestionIndex];
  const totalQuestions = campaign.questions.length;
  const isLastQuestion = currentQuestionIndex === totalQuestions - 1;

  document.getElementById('content').innerHTML = `
    <div class="text-center mb-4">
      <div class="text-white/50 text-sm mb-2">Question ${currentQuestionIndex + 1} of ${totalQuestions}</div>
      <h3 class="text-white text-xl font-bold mb-6">${question}</h3>
    </div>

    <textarea id="textInput" 
              onkeyup="checkTextInput()"
              placeholder="Type your answer here..." 
              rows="6" 
              maxlength="500"
              class="w-full p-4 rounded-xl mb-2 resize-none"></textarea>
    
    <div class="text-white/40 text-xs text-right mb-6">
      <span id="charCount">0</span>/500 characters
    </div>

    <button id="nextBtn" onclick="${isLastQuestion ? 'submitText()' : 'nextTextQuestion()'}" 
            class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg opacity-50 cursor-not-allowed" 
            disabled>
      ${isLastQuestion ? 'Submit & Get Paid ‚Üí' : 'Next Question ‚Üí'}
    </button>
  `;
}

function checkTextInput() {
  const input = document.getElementById('textInput');
  const count = input.value.length;
  document.getElementById('charCount').textContent = count;
  
  const campaign = campaigns[0];
  const question = campaign.questions[currentQuestionIndex];
  
  const nextBtn = document.getElementById('nextBtn');
  if (count > 10) {
    formData[`question_${currentQuestionIndex}`] = {
      question: question,
      answer: input.value
    };
    nextBtn.disabled = false;
    nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
  } else {
    nextBtn.disabled = true;
    nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
}

function nextTextQuestion() {
  currentQuestionIndex++;
  renderStep2();
}

async function submitText() {
  console.log('üí¨ Submitting text feedback:', formData);
  
  const campaign = campaigns[0];
  
  // Build readable text content from all answers
  let textContent = '';
  Object.values(formData).forEach((item, index) => {
    textContent += `Q${index + 1}: ${item.question}\nA: ${item.answer}\n\n`;
  });
  
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/submissions`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify({
        task_id: campaign.id,
        brand_id: BRAND_ID,
        submission_type: 'text_feedback',
        text_content: textContent.trim(),
        survey_responses: formData,
        status: 'pending',
        customer_email: 'test@example.com'
      })
    });

    if (response.ok) {
      console.log('‚úÖ Text feedback submitted successfully!');
      renderStep3();
    } else {
      const error = await response.json();
      console.error('‚ùå Submission failed:', error);
      alert('Submission failed. Please try again.');
    }
  } catch (error) {
    console.error('‚ùå Submission error:', error);
    alert('Submission failed. Please try again.');
  }
}

  
// VIDEO/AUDIO/IMAGE 
  
function renderVideoUpload(campaign) {
  document.getElementById('content').innerHTML = `
    <div class="text-center mb-4">
      <h3 class="text-white text-xl font-bold mb-2">${campaign.title}</h3>
      <p class="text-white/60 text-sm">${campaign.description}</p>
    </div>

    <div id="videoArea" class="campaign-area rounded-2xl p-4 mb-4 min-h-[320px] flex flex-col items-center justify-center">
      <div id="videoPlaceholder" class="text-center">
        <div class="text-6xl mb-4">üé•</div>
        <p class="text-white/80 text-lg font-semibold mb-2">Ready to record?</p>
        <p class="text-white/50 text-sm">Max 90 seconds</p>
      </div>
      
      <video id="videoPreview" class="hidden w-full rounded-lg" autoplay muted playsinline></video>
      <video id="videoPlayback" class="hidden w-full rounded-lg" controls playsinline></video>
      
      <div id="videoTimer" class="hidden text-white text-3xl font-mono mt-4">0:00</div>
    </div>

    <button id="videoRecordBtn" onclick="startVideoRecording()" 
            class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg">
      üé• Start Recording
    </button>
    
    <div id="videoActions" class="hidden space-y-3">
      <button onclick="retakeVideo()" 
              class="w-full py-3 bg-gray-800 text-white rounded-xl hover:bg-gray-700 transition font-semibold">
        üîÑ Retake
      </button>
      <button onclick="submitVideo()" 
              class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg">
        Submit & Get Paid ‚Üí
      </button>
    </div>
  `;
}

function renderAudioUpload(campaign) {
  document.getElementById('content').innerHTML = `
    <div class="text-center mb-6">
      <h3 class="text-white text-xl font-bold mb-2">${campaign.title}</h3>
      <p class="text-white/60 text-sm">${campaign.description}</p>
    </div>

    <div id="recordingArea" class="campaign-area rounded-2xl p-8 mb-6 min-h-[280px] flex flex-col items-center justify-center">
      <div class="text-center">
        <div class="text-6xl mb-4">üé§</div>
        <p class="text-white/80 text-lg font-semibold mb-2">Ready to record?</p>
        <p class="text-white/50 text-sm mb-4">Max 60 seconds</p>
        <div id="timer" class="text-white/70 text-2xl font-mono mb-4 hidden">0:00</div>
        <div id="audioPreview" class="hidden w-full"></div>
      </div>
    </div>

    <button id="recordBtn" onclick="startAudioRecording()" 
            class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg">
      üé§ Start Recording
    </button>
    
    <div id="audioActions" class="hidden space-y-3">
      <button onclick="retakeAudio()" 
              class="w-full py-3 bg-gray-800 text-white rounded-xl hover:bg-gray-700 transition font-semibold">
        üîÑ Retake
      </button>
      <button onclick="submitAudio()" 
              class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg">
        Submit & Get Paid ‚Üí
      </button>
    </div>
  `;
}

// Audio recording variables
let mediaRecorder;
let audioChunks = [];
let recordingTimer;
let recordingSeconds = 0;
let audioBlob;
  

async function startAudioRecording() {
  try {
    // Request microphone permission
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    recordingSeconds = 0;
    
    // Show timer
    document.getElementById('timer').classList.remove('hidden');
    document.getElementById('recordBtn').textContent = '‚èπÔ∏è Stop Recording';
    document.getElementById('recordBtn').onclick = stopAudioRecording;
    document.getElementById('recordBtn').classList.remove('bg-[#CCFF66]');
    document.getElementById('recordBtn').classList.add('bg-red-500', 'hover:bg-red-600');
    
    // Collect audio data
    mediaRecorder.ondataavailable = (event) => {
      audioChunks.push(event.data);
    };
    
    // When recording stops
    mediaRecorder.onstop = () => {
      audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      showAudioPreview();
      
      // Stop all tracks
      stream.getTracks().forEach(track => track.stop());
    };
    
    // Start recording
    mediaRecorder.start();
    
    // Start timer
    recordingTimer = setInterval(() => {
      recordingSeconds++;
      const minutes = Math.floor(recordingSeconds / 60);
      const seconds = recordingSeconds % 60;
      document.getElementById('timer').textContent = 
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // Auto-stop at 60 seconds
      if (recordingSeconds >= 60) {
        stopAudioRecording();
      }
    }, 1000);
    
  } catch (error) {
    console.error('Microphone access denied:', error);
    alert('Please allow microphone access to record audio.');
  }
}

function stopAudioRecording() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
    clearInterval(recordingTimer);
  }
}

function showAudioPreview() {
  const audioURL = URL.createObjectURL(audioBlob);
  
  // Update the recording area to show preview
  document.getElementById('recordingArea').innerHTML = `
    <div class="w-full">
      <div class="text-center mb-4">
        <div class="text-6xl mb-2">‚úÖ</div>
        <p class="text-white/80 text-lg font-semibold mb-1">Recording complete!</p>
        <p class="text-white/50 text-sm">Listen to your recording below</p>
      </div>
      
      <div class="bg-black/30 rounded-xl p-6 mb-4">
        <audio controls class="w-full" src="${audioURL}" style="height: 54px;"></audio>
      </div>
      
      <div class="flex items-center justify-center gap-2 text-white/60 text-sm">
        <span>‚è±Ô∏è</span>
        <span>${Math.floor(recordingSeconds / 60)}:${(recordingSeconds % 60).toString().padStart(2, '0')}</span>
      </div>
    </div>
  `;
  
  // Hide record button, show actions
  document.getElementById('recordBtn').classList.add('hidden');
  document.getElementById('audioActions').classList.remove('hidden');
}

function retakeAudio() {
  // Reset UI
  document.getElementById('timer').textContent = '0:00';
  document.getElementById('timer').classList.add('hidden');
  document.getElementById('audioPreview').classList.add('hidden');
  document.getElementById('audioActions').classList.add('hidden');
  
  document.getElementById('recordBtn').classList.remove('hidden', 'bg-red-500', 'hover:bg-red-600');
  document.getElementById('recordBtn').classList.add('bg-[#CCFF66]', 'hover:bg-[#b8e659]');
  document.getElementById('recordBtn').textContent = 'üé§ Start Recording';
  document.getElementById('recordBtn').onclick = startAudioRecording;
  
  // Clear data
  audioChunks = [];
  audioBlob = null;
  recordingSeconds = 0;
}

async function submitAudio() {
  const campaign = campaigns[0];
  
  // Show uploading state
  document.getElementById('audioActions').innerHTML = `
    <div class="text-center text-white/70 py-4">
      <div class="text-4xl mb-2">‚è≥</div>
      <p>Converting and uploading audio...</p>
    </div>
  `;
  
  try {
    // Convert WebM blob to MP3
    const arrayBuffer = await audioBlob.arrayBuffer();
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
    
    // Get audio data
    const channelData = audioBuffer.getChannelData(0);
    const samples = new Int16Array(channelData.length);
    for (let i = 0; i < channelData.length; i++) {
      samples[i] = Math.max(-1, Math.min(1, channelData[i])) * 0x7FFF;
    }
    
    // Encode to MP3
    const mp3encoder = new lamejs.Mp3Encoder(1, audioBuffer.sampleRate, 128);
    const mp3Data = [];
    const sampleBlockSize = 1152;
    
    for (let i = 0; i < samples.length; i += sampleBlockSize) {
      const sampleChunk = samples.subarray(i, i + sampleBlockSize);
      const mp3buf = mp3encoder.encodeBuffer(sampleChunk);
      if (mp3buf.length > 0) {
        mp3Data.push(mp3buf);
      }
    }
    
    const mp3buf = mp3encoder.flush();
    if (mp3buf.length > 0) {
      mp3Data.push(mp3buf);
    }
    
    // Create MP3 blob
    const mp3Blob = new Blob(mp3Data, { type: 'audio/mp3' });
    
    // Upload MP3 to Supabase Storage
    const fileName = `audio_${Date.now()}_${Math.random().toString(36).substr(2, 9)}.mp3`;
    
    const uploadResponse = await fetch(
      `${SUPABASE_URL}/storage/v1/object/campaign-audio/${fileName}`,
      {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'audio/mp3'
        },
        body: mp3Blob
      }
    );
    
    if (!uploadResponse.ok) throw new Error('Upload failed');
    
    // Get public URL
    const audioUrl = `${SUPABASE_URL}/storage/v1/object/public/campaign-audio/${fileName}`;
    console.log('‚úÖ MP3 uploaded:', audioUrl);
    
    // Save submission to database
    const response = await fetch(`${SUPABASE_URL}/rest/v1/submissions`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify({
        task_id: campaign.id,
        brand_id: BRAND_ID,
        submission_type: 'audio_upload',
        audio_url: audioUrl,
        status: 'pending',
        customer_email: 'test@example.com'
      })
    });

    if (response.ok) {
      console.log('‚úÖ Audio submission saved!');
      renderStep3();
    } else {
      throw new Error('Failed to save submission');
    }
    
  } catch (error) {
    console.error('‚ùå Upload failed:', error);
    alert('Upload failed. Please try again.');
    retakeAudio();
  }
}

// Video recording variables
let videoStream;
let videoRecorder;
let videoChunks = [];
let videoTimer;
let videoSeconds = 0;
let videoBlob;

async function startVideoRecording() {
  try {
    // Request camera and microphone
    videoStream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: 'user' },
      audio: true 
    });
    
    // Show camera preview
    const preview = document.getElementById('videoPreview');
    preview.srcObject = videoStream;
    preview.classList.remove('hidden');
    document.getElementById('videoPlaceholder').classList.add('hidden');
    
    // Initialize recorder
    videoRecorder = new MediaRecorder(videoStream, {
      mimeType: 'video/webm;codecs=vp8,opus'
    });
    videoChunks = [];
    videoSeconds = 0;
    
    // Update button
    const btn = document.getElementById('videoRecordBtn');
    btn.textContent = '‚èπÔ∏è Stop Recording';
    btn.onclick = stopVideoRecording;
    btn.classList.remove('bg-[#CCFF66]', 'hover:bg-[#b8e659]');
    btn.classList.add('bg-red-500', 'hover:bg-red-600');
    
    // Show timer
    document.getElementById('videoTimer').classList.remove('hidden');
    
    // Collect video data
    videoRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) {
        videoChunks.push(event.data);
      }
    };
    
    // When recording stops
    videoRecorder.onstop = () => {
      videoBlob = new Blob(videoChunks, { type: 'video/webm' });
      showVideoPlayback();
      
      // Stop camera
      videoStream.getTracks().forEach(track => track.stop());
    };
    
    // Start recording
    videoRecorder.start();
    
    // Start timer
    videoTimer = setInterval(() => {
      videoSeconds++;
      const minutes = Math.floor(videoSeconds / 60);
      const seconds = videoSeconds % 60;
      document.getElementById('videoTimer').textContent = 
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // Auto-stop at 90 seconds
      if (videoSeconds >= 90) {
        stopVideoRecording();
      }
    }, 1000);
    
  } catch (error) {
    console.error('Camera access denied:', error);
    alert('Please allow camera and microphone access to record video.');
  }
}

function stopVideoRecording() {
  if (videoRecorder && videoRecorder.state !== 'inactive') {
    videoRecorder.stop();
    clearInterval(videoTimer);
  }
}

function showVideoPlayback() {
  const videoURL = URL.createObjectURL(videoBlob);
  
  // Hide preview, show playback
  document.getElementById('videoPreview').classList.add('hidden');
  const playback = document.getElementById('videoPlayback');
  playback.src = videoURL;
  playback.classList.remove('hidden');
  
  // Update timer to show final duration
  document.getElementById('videoTimer').textContent = 
    `${Math.floor(videoSeconds / 60)}:${(videoSeconds % 60).toString().padStart(2, '0')}`;
  
  // Hide record button, show actions
  document.getElementById('videoRecordBtn').classList.add('hidden');
  document.getElementById('videoActions').classList.remove('hidden');
}

function retakeVideo() {
  // Reset UI
  document.getElementById('videoTimer').textContent = '0:00';
  document.getElementById('videoTimer').classList.add('hidden');
  document.getElementById('videoPlayback').classList.add('hidden');
  document.getElementById('videoPlaceholder').classList.remove('hidden');
  document.getElementById('videoActions').classList.add('hidden');
  
  const btn = document.getElementById('videoRecordBtn');
  btn.classList.remove('hidden', 'bg-red-500', 'hover:bg-red-600');
  btn.classList.add('bg-[#CCFF66]', 'hover:bg-[#b8e659]');
  btn.textContent = 'üé• Start Recording';
  btn.onclick = startVideoRecording;
  
  // Clear data
  videoChunks = [];
  videoBlob = null;
  videoSeconds = 0;
}

async function submitVideo() {
  const campaign = campaigns[0];
  
  // Show uploading state
  document.getElementById('videoActions').innerHTML = `
    <div class="text-center text-white/70 py-4">
      <div class="text-4xl mb-2">‚è≥</div>
      <p>Uploading video...</p>
      <p class="text-sm text-white/50 mt-2">This may take a moment...</p>
    </div>
  `;
  
  try {
    // Upload WebM to Supabase Storage
    const fileName = `video_${Date.now()}_${Math.random().toString(36).substr(2, 9)}.webm`;
    
    const uploadResponse = await fetch(
      `${SUPABASE_URL}/storage/v1/object/campaign-videos/${fileName}`,
      {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'video/webm'
        },
        body: videoBlob
      }
    );
    
    if (!uploadResponse.ok) throw new Error('Upload failed');
    
    // Get public URL
    const videoUrl = `${SUPABASE_URL}/storage/v1/object/public/campaign-videos/${fileName}`;
    console.log('‚úÖ Video uploaded:', videoUrl);
    
    // Save submission to database
    const response = await fetch(`${SUPABASE_URL}/rest/v1/submissions`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify({
        task_id: campaign.id,
        brand_id: BRAND_ID,
        submission_type: 'video_upload',
        video_url: videoUrl,
        status: 'pending',
        customer_email: 'test@example.com'
      })
    });

    if (response.ok) {
      console.log('‚úÖ Video submission saved!');
      renderStep3();
    } else {
      throw new Error('Failed to save submission');
    }
    
  } catch (error) {
    console.error('‚ùå Upload failed:', error);
    alert('Upload failed. Please try again.');
    retakeVideo();
  }
}
  
  function renderImageUpload(campaign) {
  document.getElementById('content').innerHTML = `
    <div class="text-center mb-4">
      <h3 class="text-white text-xl font-bold mb-2">${campaign.title}</h3>
      <p class="text-white/60 text-sm">${campaign.description}</p>
    </div>

    <div id="imageArea" class="campaign-area rounded-2xl p-6 mb-4 min-h-[320px] flex flex-col items-center justify-center">
      <div id="imagePlaceholder" class="text-center">
        <div class="text-6xl mb-4">üì∏</div>
        <p class="text-white/80 text-lg font-semibold mb-2">Add a photo</p>
        <p class="text-white/50 text-sm">Take or upload from device</p>
      </div>
      
      <img id="imagePreview" class="hidden w-full rounded-lg max-h-[400px] object-contain" />
      <input type="file" id="imageInput" accept="image/*" capture="environment" class="hidden" />
    </div>

    <div id="imageButtons" class="space-y-3">
      <button onclick="openCamera()" 
              class="w-full py-3 bg-gray-800 text-white rounded-xl hover:bg-gray-700 transition font-semibold">
        üì∑ Take Photo
      </button>
      <button onclick="openFilePicker()" 
              class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg">
        üìÅ Choose from Device
      </button>
    </div>
    
    <div id="imageActions" class="hidden space-y-3">
      <button onclick="retakeImage()" 
              class="w-full py-3 bg-gray-800 text-white rounded-xl hover:bg-gray-700 transition font-semibold">
        üîÑ Choose Different Photo
      </button>
      <button onclick="submitImage()" 
              class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg">
        Submit & Get Paid ‚Üí
      </button>
    </div>
  `;
}

  // Image upload variables
let imageBlob;

function openCamera() {
  const input = document.getElementById('imageInput');
  input.setAttribute('capture', 'environment'); // Use back camera on mobile
  input.click();
  
  input.onchange = (e) => {
    if (e.target.files && e.target.files[0]) {
      handleImageSelect(e.target.files[0]);
    }
  };
}

function openFilePicker() {
  const input = document.getElementById('imageInput');
  input.removeAttribute('capture'); // Allow gallery selection
  input.click();
  
  input.onchange = (e) => {
    if (e.target.files && e.target.files[0]) {
      handleImageSelect(e.target.files[0]);
    }
  };
}

function handleImageSelect(file) {
  // Validate file type
  if (!file.type.startsWith('image/')) {
    alert('Please select a valid image file');
    return;
  }
  
  // Validate file size (max 10MB)
  if (file.size > 10 * 1024 * 1024) {
    alert('Image too large. Please choose an image under 10MB');
    return;
  }
  
  imageBlob = file;
  
  // Show preview
  const reader = new FileReader();
  reader.onload = (e) => {
    document.getElementById('imagePlaceholder').classList.add('hidden');
    const preview = document.getElementById('imagePreview');
    preview.src = e.target.result;
    preview.classList.remove('hidden');
    
    // Show actions, hide buttons
    document.getElementById('imageButtons').classList.add('hidden');
    document.getElementById('imageActions').classList.remove('hidden');
  };
  reader.readAsDataURL(file);
}

function retakeImage() {
  // Reset UI
  document.getElementById('imagePreview').classList.add('hidden');
  document.getElementById('imagePlaceholder').classList.remove('hidden');
  document.getElementById('imageActions').classList.add('hidden');
  document.getElementById('imageButtons').classList.remove('hidden');
  
  // Clear data
  imageBlob = null;
  document.getElementById('imageInput').value = '';
}

async function submitImage() {
  const campaign = campaigns[0];
  
  // Show uploading state
  document.getElementById('imageActions').innerHTML = `
    <div class="text-center text-white/70 py-4">
      <div class="text-4xl mb-2">‚è≥</div>
      <p>Uploading image...</p>
    </div>
  `;
  
  try {
    // Upload to Supabase Storage
    const fileExtension = imageBlob.type.split('/')[1] || 'jpg';
    const fileName = `image_${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExtension}`;
    
    const uploadResponse = await fetch(
      `${SUPABASE_URL}/storage/v1/object/campaign-images/${fileName}`,
      {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': imageBlob.type
        },
        body: imageBlob
      }
    );
    
    if (!uploadResponse.ok) throw new Error('Upload failed');
    
    // Get public URL
    const imageUrl = `${SUPABASE_URL}/storage/v1/object/public/campaign-images/${fileName}`;
    console.log('‚úÖ Image uploaded:', imageUrl);
    
    // Save submission to database
    const response = await fetch(`${SUPABASE_URL}/rest/v1/submissions`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify({
        task_id: campaign.id,
        brand_id: BRAND_ID,
        submission_type: 'image_upload',
        image_url: imageUrl,
        status: 'pending',
        customer_email: 'test@example.com'
      })
    });

    if (response.ok) {
      console.log('‚úÖ Image submission saved!');
      renderStep3();
    } else {
      throw new Error('Failed to save submission');
    }
    
  } catch (error) {
    console.error('‚ùå Upload failed:', error);
    alert('Upload failed. Please try again.');
    retakeImage();
  }
}

// ============================================
// STEP 3: EMAIL + STRIPE (Placeholder)
// ============================================
function renderStep3() {
  document.getElementById('backBtn').classList.add('hidden');

  const campaign = campaigns[0];
  const submission = formData; // Keep submission data

  document.getElementById('content').innerHTML = `
    <div class="text-center mb-6">
      <div class="text-6xl mb-4">üéâ</div>
      <h3 class="text-white text-2xl font-bold mb-2">Great job!</h3>
      <p class="text-white/70 text-sm mb-6">You've completed the task</p>
    </div>

    <div class="campaign-area rounded-2xl p-6 mb-6">
      <p class="text-white/80 text-center mb-4">Enter your email to receive payment:</p>
      <input type="email" 
             id="emailInput"
             placeholder="your@email.com" 
             class="w-full p-3 rounded-xl mb-4">
      <div id="errorMsg" class="text-red-400 text-sm mb-2 hidden"></div>
    </div>

    <button id="connectBtn" onclick="handleStripeConnect()" 
            class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg">
      Continue to Bank Link ‚Üí
    </button>

    <p class="text-white/40 text-xs text-center mt-4">
      You'll receive ¬£${campaign.reward} within 24-48 hours after approval
    </p>
  `;
}

async function handleStripeConnect() {
  const email = document.getElementById('emailInput').value.trim();
  const errorMsg = document.getElementById('errorMsg');
  const btn = document.getElementById('connectBtn');

  if (!email || !email.includes('@')) {
    errorMsg.textContent = 'Please enter a valid email address';
    errorMsg.classList.remove('hidden');
    return;
  }

  errorMsg.classList.add('hidden');
  btn.disabled = true;
  btn.textContent = 'Preparing...';

  try {
    document.getElementById('content').innerHTML = `
      <div class="text-center">
        <div class="text-6xl mb-6 loading">üîê</div>
        <h3 class="text-white text-2xl font-bold mb-4">Setting up secure payment</h3>
        <p class="text-white/70 text-lg mb-6">
          You'll be redirected to Stripe to link your bank account
        </p>
        <div class="bg-gray-900/50 rounded-xl p-6 mb-6">
          <div class="flex items-start gap-4 text-left">
            <div class="text-3xl">‚úÖ</div>
            <div>
              <p class="text-white font-semibold mb-2">Why Stripe?</p>
              <p class="text-white/60 text-sm">
                Stripe is a trusted payment platform used by millions worldwide. 
                Your banking details stay completely secure and private.
              </p>
            </div>
          </div>
        </div>
        <p class="text-white/40 text-sm">Redirecting in a moment...</p>
      </div>
    `;
    
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    const response = await fetch('https://amphi-dashboard.vercel.app/api/create-stripe-account', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: email, submissionId: 'pending' })
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.message || 'Failed to create account');
    }

    // Update the most recent submission with the real email
const campaign = campaigns[0];

const updateSubmission = await fetch(
  `${SUPABASE_URL}/rest/v1/submissions?task_id=eq.${campaign.id}&customer_email=eq.test@example.com&order=created_at.desc&limit=1`,
  {
    method: 'PATCH',
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal'
    },
    body: JSON.stringify({
      customer_email: email
    })
  }
);

if (!updateSubmission.ok) {
  console.error('Failed to update submission with real email');
} else {
  console.log('‚úÖ Updated submission with real email:', email);
}

// Mark campaign as completed
markCampaignCompleted(campaign.id);

// Handle onboarding or success
if (data.alreadyOnboarded) {
  showSuccessScreen();
} else if (data.onboardingUrl) {
  console.log('‚úÖ Redirecting to Stripe');
  window.location.href = data.onboardingUrl;
}
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    
    document.getElementById('content').innerHTML = `
      <div class="text-center">
        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
        <h3 class="text-white text-xl font-bold mb-2">Something went wrong</h3>
        <p class="text-white/70 text-sm mb-6">${error.message}</p>
        <button onclick="renderStep3()" 
                class="px-6 py-3 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all">
          Try Again
        </button>
      </div>
    `;
  }
}
  
function showSuccessScreen() {
  const campaign = campaigns[0];
  
  document.getElementById('content').innerHTML = `
    <div class="text-center">
      <div class="text-6xl mb-4">‚úÖ</div>
      <h3 class="text-white text-2xl font-bold mb-2">All set!</h3>
      <p class="text-white/70 text-sm mb-6">
        Your submission has been received and your bank account is linked.
      </p>
      <p class="text-white/60 text-sm">
        You'll receive ¬£${campaign.reward} within 24-48 hours after approval.
      </p>
    </div>
  `;
}


function minimizeWidget() {
  const widget = document.getElementById('widget-root');
  widget.style.transition = 'opacity 0.3s ease';
  widget.style.opacity = '0';
  
  setTimeout(() => {
    widget.style.display = 'none';
  }, 300);
}

  
function showFinalSuccess() {
  document.getElementById('backBtn').classList.add('hidden');
  
  document.getElementById('content').innerHTML = `
    <div class="text-center">
      <div class="text-6xl mb-6">üéâ</div>
      <h2 class="text-white text-3xl font-bold mb-4">All done!</h2>
      <p class="text-white/80 text-lg mb-4">
        Your submission has been received and your bank account is linked.
      </p>
      <div class="bg-[#CCFF66]/10 border border-[#CCFF66]/30 rounded-xl p-6 mb-6">
        <p class="text-[#CCFF66] font-semibold mb-2">What happens next?</p>
        <p class="text-white/70 text-sm">
          The brand will review your submission. Once approved, you'll receive your payment within 24-48 hours.
        </p>
      </div>
      <button onclick="minimizeWidget()" 
              class="w-full py-3 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all">
        Close
      </button>
    </div>
  `;
}
  
// ============================================
// INIT: Load campaigns on startup
// ============================================
loadCampaigns();
</script>

</body>
</html>
