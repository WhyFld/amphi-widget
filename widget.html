<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AMPHI Widget</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: transparent;
    }

    .glass-popup {
      background: rgba(0, 0, 0, 0.40);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: 
        0 8px 32px 0 rgba(0, 0, 0, 0.15),
        inset 0 1px 0 0 rgba(255, 255, 255, 0.2);
    }

    .glass-popup h2,
    .glass-popup p {
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .campaign-area {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .popup-enter {
      animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideInFromRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideInFromLeft {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .slide-right {
      animation: slideInFromRight 0.3s ease-out;
    }

    .slide-left {
      animation: slideInFromLeft 0.3s ease-out;
    }

    .carousel-dot {
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .carousel-dot.active {
      background: #CCFF66;
      width: 24px;
      border-radius: 4px;
      box-shadow: 0 2px 12px rgba(204, 255, 102, 0.5);
    }

    .arrow-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.25);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 30;
    }

    .arrow-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-50%) scale(1.05);
    }

    .arrow-btn.left {
      left: 8px;
    }

    .arrow-btn.right {
      right: 8px;
    }

    .poll-option {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      transition: all 0.2s;
    }
    .poll-option:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(204, 255, 102, 0.5);
    }
    .poll-option.selected {
      background: rgba(204, 255, 102, 0.2);
      border-color: #CCFF66;
    }

    textarea, input[type="text"], input[type="email"] {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      outline: none;
    }
    textarea:focus, input:focus {
      border-color: #CCFF66;
      background: rgba(255, 255, 255, 0.15);
    }
    textarea::placeholder, input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .loading {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
  </style>
</head>
<body>

<div id="widget-root" class="w-full h-screen flex items-center justify-center p-4">
  <div class="glass-popup popup-enter rounded-3xl w-full max-w-lg relative overflow-hidden" style="min-height: 520px;">
    
<button onclick="minimizeWidget()" class="absolute top-4 right-4 text-white/60 hover:text-white text-2xl font-bold w-8 h-8 flex items-center justify-center transition-all hover:scale-110 z-50">
  √ó
</button>

    <button id="backBtn" onclick="goBack()" class="absolute top-4 left-4 text-white/60 hover:text-white text-xl font-bold z-10 transition-colors hidden">
      ‚Üê Back
    </button>

    <button id="leftArrow" onclick="prevCampaign()" class="arrow-btn left hidden">
      <span class="text-xl">‚Üê</span>
    </button>
    <button id="rightArrow" onclick="nextCampaign()" class="arrow-btn right hidden">
      <span class="text-xl">‚Üí</span>
    </button>

    <div id="content" class="p-8 pt-12">
      <div class="text-center">
        <div class="text-4xl mb-4 loading">‚è≥</div>
        <p class="text-white/70">Loading campaigns...</p>
      </div>
    </div>

    <div class="text-center pb-4 text-white/30 text-xs">
      Powered by AMPHI
    </div>

  </div>
</div>

<div id="minimizedIcon" class="hidden fixed bottom-6 right-6 z-50 cursor-pointer group" onclick="restoreWidget()">
  <div class="relative">
    <!-- Icon Circle -->
    <div class="w-16 h-16 rounded-full bg-[#CCFF66] flex items-center justify-center shadow-2xl transform transition-all duration-300 group-hover:scale-110">
      <span class="text-3xl">üí¨</span>
    </div>
    <!-- Pulse Animation -->
    <div class="absolute inset-0 rounded-full bg-[#CCFF66] opacity-20 animate-ping"></div>
  </div>
</div>
  
<script>
// ============================================
// SUPABASE CONNECTION
// ============================================
const SUPABASE_URL = 'https://puhsbgrublugmqqgvmqd.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1aHNiZ3J1Ymx1Z21xcWd2bXFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTE5MjQsImV4cCI6MjA3NTU4NzkyNH0.tFzNj4RMmgxa2hm_nf0IR1dvedy2u3GST2LmjLeV6WE';
const BRAND_ID = '3c4b9a71-3aa4-4a9d-b17c-5bedf24b50c2'; // Your test brand

// Track completed campaigns in localStorage
function getCompletedCampaigns() {
  const completed = localStorage.getItem('amphi_completed_campaigns');
  return completed ? JSON.parse(completed) : [];
}

function markCampaignCompleted(campaignId) {
  const completed = getCompletedCampaigns();
  if (!completed.includes(campaignId)) {
    completed.push(campaignId);
    localStorage.setItem('amphi_completed_campaigns', JSON.stringify(completed));
  }
}

function isCampaignCompleted(campaignId) {
  return getCompletedCampaigns().includes(campaignId);
}


  
// ============================================
// STATE MANAGEMENT
// ============================================
let currentStep = 1;
let currentCampaignIndex = 0;
let currentQuestionIndex = 0;
let formData = {};
let campaigns = [];

// ============================================
// FETCH CAMPAIGNS FROM SUPABASE
// ============================================
async function loadCampaigns() {
  try {
    const response = await fetch(
      `${SUPABASE_URL}/rest/v1/tasks?brand_id=eq.${BRAND_ID}&is_active=eq.true&select=*`,
      {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      }
    );

    const data = await response.json();
    
    if (!data || data.length === 0) {
      showError('No active campaigns found');
      return;
    }

    // Transform Supabase data to widget format
    campaigns = data.map(task => {
      const campaign = {
        id: task.id,
        type: task.task_type,
        title: task.title,
        description: task.description,
        reward: task.reward_amount,
        icon: getIconForType(task.task_type)
      };

      // Parse required_fields for polls and text_feedback
      if (task.required_fields) {
        if (task.task_type === 'poll') {
          campaign.questions = task.required_fields.map(field => ({
            question: field.question,
            options: field.options
          }));
        } else if (task.task_type === 'text_feedback') {
          campaign.questions = task.required_fields.map(field => field.question);
        }
      }

      if (task.instructions_text) {
        campaign.instructions = task.instructions_text;
      }

      return campaign;
    });

    console.log('‚úÖ Loaded campaigns:', campaigns);

     // Filter out campaigns user has already completed
    const completedIds = getCompletedCampaigns();
    campaigns = campaigns.filter(c => !completedIds.includes(c.id));

    console.log('‚úÖ Available campaigns (after filtering completed):', campaigns);

    if (campaigns.length === 0) {
      showNoMoreCampaigns();
      return;
    }

    
    // Check if returning from Stripe
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      const email = urlParams.get('email');
      
      await fetch(`${SUPABASE_URL}/rest/v1/customers?email=eq.${encodeURIComponent(email)}`, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          stripe_onboarding_completed: true
        })
      });
      
      showFinalSuccess();
      window.history.replaceState({}, '', window.location.pathname);
      return;
    }
    renderStep1();

  } catch (error) {
    console.error('‚ùå Failed to load campaigns:', error);
    showError('Failed to load campaigns');
  }
}

function getIconForType(type) {
  const icons = {
    'poll': 'üìä',
    'text_feedback': 'üí¨',
    'video_upload': 'üé•',
    'audio_upload': 'üé§',
    'image_upload': 'üì∏'
  };
  return icons[type] || 'üìã';
}

function showError(message) {
  document.getElementById('content').innerHTML = `
    <div class="text-center">
      <div class="text-4xl mb-4">‚ö†Ô∏è</div>
      <p class="text-white/70">${message}</p>
    </div>
  `;
}

// ============================================
// NAVIGATION
// ============================================
function goBack() {
  if (currentStep === 2) {
    currentStep = 1;
    currentQuestionIndex = 0;
    formData = {};
    renderStep1();
  }
}

function closeWidget() {
  minimizeWidget();
}

function nextCampaign() {
  currentCampaignIndex = (currentCampaignIndex + 1) % campaigns.length;
  const content = document.getElementById('content');
  content.classList.remove('slide-left', 'slide-right');
  void content.offsetWidth;
  content.classList.add('slide-right');
  renderStep1();
}

function prevCampaign() {
  currentCampaignIndex = (currentCampaignIndex - 1 + campaigns.length) % campaigns.length;
  const content = document.getElementById('content');
  content.classList.remove('slide-left', 'slide-right');
  void content.offsetWidth;
  content.classList.add('slide-left');
  renderStep1();
}

function startCampaign() {
  currentStep = 2;
  currentQuestionIndex = 0;
  formData = {};
  renderStep2();
}

// ============================================
// STEP 1: CAMPAIGN CAROUSEL
// ============================================
function renderStep1() {
  document.getElementById('backBtn').classList.add('hidden');
  
  if (campaigns.length > 1) {
    document.getElementById('leftArrow').classList.remove('hidden');
    document.getElementById('rightArrow').classList.remove('hidden');
  } else {
    document.getElementById('leftArrow').classList.add('hidden');
    document.getElementById('rightArrow').classList.add('hidden');
  }
  
  const campaign = campaigns[currentCampaignIndex];
  
  let taskDetails = '';
  if (campaign.type === 'poll') {
    taskDetails = `${campaign.questions.length} quick questions`;
  } else if (campaign.type === 'text_feedback') {
    taskDetails = `${campaign.questions.length} text questions`;
  } else if (campaign.type === 'video_upload') {
    taskDetails = 'Record 90-second video';
  } else if (campaign.type === 'audio_upload') {
    taskDetails = 'Record 60-second audio';
  } else if (campaign.type === 'image_upload') {
    taskDetails = 'Upload 1 photo';
  }

  document.getElementById('content').innerHTML = `
    <h2 class="text-white text-2xl font-bold text-center mb-8">
      ${campaign.title} & earn ¬£${campaign.reward}
    </h2>

    <div class="campaign-area rounded-2xl p-8 mb-6 min-h-[280px] flex items-center justify-center">
      <div class="text-center">
        <div class="text-6xl mb-4">${campaign.icon}</div>
        <p class="text-white/80 text-lg font-semibold mb-2">${campaign.title}</p>
        <p class="text-white/50 text-sm mb-1">${campaign.description}</p>
        <p class="text-white/40 text-xs mt-2">${taskDetails}</p>
      </div>
    </div>

    <div class="flex justify-center gap-2 mb-6">
      ${campaigns.map((c, i) => `
        <div class="carousel-dot ${i === currentCampaignIndex ? 'active' : 'h-2 w-2 rounded-full bg-white/30'}"></div>
      `).join('')}
    </div>

    <button onclick="startCampaign()" class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg">
      Start & Earn ¬£${campaign.reward} ‚Üí
    </button>
  `;
}

// ============================================
// STEP 2: CAMPAIGN FORM
// ============================================
function renderStep2() {
  document.getElementById('backBtn').classList.remove('hidden');
  document.getElementById('leftArrow').classList.add('hidden');
  document.getElementById('rightArrow').classList.add('hidden');
  
  const campaign = campaigns[currentCampaignIndex];

  if (campaign.type === 'poll') {
    renderPoll(campaign);
  } else if (campaign.type === 'text_feedback') {
    renderTextFeedback(campaign);
  } else if (campaign.type === 'video_upload') {
    renderVideoUpload(campaign);
  } else if (campaign.type === 'audio_upload') {
    renderAudioUpload(campaign);
  } else if (campaign.type === 'image_upload') {
    renderImageUpload(campaign);
  }
}

// POLL
function renderPoll(campaign) {
  const question = campaign.questions[currentQuestionIndex];
  const totalQuestions = campaign.questions.length;
  const isLastQuestion = currentQuestionIndex === totalQuestions - 1;

  document.getElementById('content').innerHTML = `
    <div class="text-center mb-4">
      <div class="text-white/50 text-sm mb-2">Question ${currentQuestionIndex + 1} of ${totalQuestions}</div>
      <h3 class="text-white text-xl font-bold">${question.question}</h3>
    </div>

    <div class="space-y-3 mb-6">
      ${question.options.map((option, i) => `
        <button onclick="selectPollOption(${i})" 
                id="poll-option-${i}"
                class="poll-option w-full py-4 px-6 rounded-xl text-white font-medium text-left">
          ${option}
        </button>
      `).join('')}
    </div>

    <button id="nextBtn" onclick="${isLastQuestion ? 'submitPoll()' : 'nextPollQuestion()'}" 
            class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg opacity-50 cursor-not-allowed" 
            disabled>
      ${isLastQuestion ? 'Submit & Get Paid ‚Üí' : 'Next Question ‚Üí'}
    </button>
  `;
}

function selectPollOption(index) {
  document.querySelectorAll('.poll-option').forEach(btn => {
    btn.classList.remove('selected');
  });
  
  document.getElementById(`poll-option-${index}`).classList.add('selected');
  
  const campaign = campaigns[currentCampaignIndex];
  const question = campaign.questions[currentQuestionIndex];
  formData[`question_${currentQuestionIndex}`] = {
    question: question.question,
    answer: question.options[index]
  };
  
  const nextBtn = document.getElementById('nextBtn');
  nextBtn.disabled = false;
  nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
}

function nextPollQuestion() {
  currentQuestionIndex++;
  renderStep2();
}

async function submitPoll() {
  console.log('üìä Submitting poll:', formData);
  
  const campaign = campaigns[currentCampaignIndex];
  
  // Build readable text content from poll answers
  let textContent = '';
  Object.values(formData).forEach((item, index) => {
    textContent += `Q${index + 1}: ${item.question}\nA: ${item.answer}\n\n`;
  });
  
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/submissions`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify({
        task_id: campaign.id,
        brand_id: BRAND_ID,
        submission_type: 'poll',
        text_content: textContent.trim(),
        survey_responses: formData,
        status: 'pending',
        customer_email: 'test@example.com'
      })
    });

    if (response.ok) {
      console.log('‚úÖ Poll submitted successfully!');
      renderStep3();
    } else {
      const error = await response.json();
      console.error('‚ùå Submission failed:', error);
      alert('Submission failed. Please try again.');
    }
  } catch (error) {
    console.error('‚ùå Submission error:', error);
    alert('Submission failed. Please try again.');
  }
}
// TEXT FEEDBACK
function renderTextFeedback(campaign) {
  const question = campaign.questions[currentQuestionIndex];
  const totalQuestions = campaign.questions.length;
  const isLastQuestion = currentQuestionIndex === totalQuestions - 1;

  document.getElementById('content').innerHTML = `
    <div class="text-center mb-4">
      <div class="text-white/50 text-sm mb-2">Question ${currentQuestionIndex + 1} of ${totalQuestions}</div>
      <h3 class="text-white text-xl font-bold mb-6">${question}</h3>
    </div>

    <textarea id="textInput" 
              onkeyup="checkTextInput()"
              placeholder="Type your answer here..." 
              rows="6" 
              maxlength="500"
              class="w-full p-4 rounded-xl mb-2 resize-none"></textarea>
    
    <div class="text-white/40 text-xs text-right mb-6">
      <span id="charCount">0</span>/500 characters
    </div>

    <button id="nextBtn" onclick="${isLastQuestion ? 'submitText()' : 'nextTextQuestion()'}" 
            class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg opacity-50 cursor-not-allowed" 
            disabled>
      ${isLastQuestion ? 'Submit & Get Paid ‚Üí' : 'Next Question ‚Üí'}
    </button>
  `;
}

function checkTextInput() {
  const input = document.getElementById('textInput');
  const count = input.value.length;
  document.getElementById('charCount').textContent = count;
  
  const campaign = campaigns[currentCampaignIndex];
  const question = campaign.questions[currentQuestionIndex];
  
  const nextBtn = document.getElementById('nextBtn');
  if (count > 10) {
    formData[`question_${currentQuestionIndex}`] = {
      question: question,
      answer: input.value
    };
    nextBtn.disabled = false;
    nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
  } else {
    nextBtn.disabled = true;
    nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
}

function nextTextQuestion() {
  currentQuestionIndex++;
  renderStep2();
}

async function submitText() {
  console.log('üí¨ Submitting text feedback:', formData);
  
  const campaign = campaigns[currentCampaignIndex];
  
  // Build readable text content from all answers
  let textContent = '';
  Object.values(formData).forEach((item, index) => {
    textContent += `Q${index + 1}: ${item.question}\nA: ${item.answer}\n\n`;
  });
  
  try {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/submissions`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify({
        task_id: campaign.id,
        brand_id: BRAND_ID,
        submission_type: 'text_feedback',
        text_content: textContent.trim(),
        survey_responses: formData,
        status: 'pending',
        customer_email: 'test@example.com'
      })
    });

    if (response.ok) {
      console.log('‚úÖ Text feedback submitted successfully!');
      renderStep3();
    } else {
      const error = await response.json();
      console.error('‚ùå Submission failed:', error);
      alert('Submission failed. Please try again.');
    }
  } catch (error) {
    console.error('‚ùå Submission error:', error);
    alert('Submission failed. Please try again.');
  }
}

  
// VIDEO/AUDIO/IMAGE (Placeholders for now)
function renderVideoUpload(campaign) {
  document.getElementById('content').innerHTML = `
    <div class="text-center mb-6">
      <h3 class="text-white text-xl font-bold mb-2">${campaign.title}</h3>
      <p class="text-white/60 text-sm">${campaign.instructions || 'Record your video'}</p>
    </div>

    <div class="campaign-area rounded-2xl p-8 mb-6 min-h-[280px] flex items-center justify-center">
      <div class="text-center">
        <div class="text-6xl mb-4">üé•</div>
        <p class="text-white/80 text-lg font-semibold mb-2">Ready to record?</p>
        <p class="text-white/50 text-sm">Max 90 seconds</p>
      </div>
    </div>

    <button onclick="alert('Video recording coming next!')" 
            class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg">
      üé• Start Recording
    </button>
  `;
}

function renderAudioUpload(campaign) {
  document.getElementById('content').innerHTML = `
    <div class="text-center mb-6">
      <h3 class="text-white text-xl font-bold mb-2">${campaign.title}</h3>
      <p class="text-white/60 text-sm">${campaign.instructions || 'Record your audio'}</p>
    </div>

    <div class="campaign-area rounded-2xl p-8 mb-6 min-h-[280px] flex items-center justify-center">
      <div class="text-center">
        <div class="text-6xl mb-4">üé§</div>
        <p class="text-white/80 text-lg font-semibold mb-2">Ready to record?</p>
        <p class="text-white/50 text-sm">Max 60 seconds</p>
      </div>
    </div>

    <button onclick="alert('Audio recording coming next!')" 
            class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg">
      üé§ Start Recording
    </button>
  `;
}

function renderImageUpload(campaign) {
  document.getElementById('content').innerHTML = `
    <div class="text-center mb-6">
      <h3 class="text-white text-xl font-bold mb-2">${campaign.title}</h3>
      <p class="text-white/60 text-sm">${campaign.instructions || 'Upload your photo'}</p>
    </div>

    <div class="campaign-area rounded-2xl p-8 mb-6 min-h-[280px] flex items-center justify-center">
      <div class="text-center">
        <div class="text-6xl mb-4">üì∏</div>
        <p class="text-white/80 text-lg font-semibold mb-2">Upload a photo</p>
        <p class="text-white/50 text-sm">JPG, PNG, or HEIC</p>
      </div>
    </div>

    <button onclick="alert('Image upload coming next!')" 
            class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg">
      üì∏ Take Photo / Upload
    </button>
  `;
}

// ============================================
// STEP 3: EMAIL + STRIPE (Placeholder)
// ============================================
function renderStep3() {
  document.getElementById('backBtn').classList.add('hidden');
  document.getElementById('leftArrow').classList.add('hidden');
  document.getElementById('rightArrow').classList.add('hidden');
  const campaign = campaigns[currentCampaignIndex];
  const submission = formData; // Keep submission data

  document.getElementById('content').innerHTML = `
    <div class="text-center mb-6">
      <div class="text-6xl mb-4">üéâ</div>
      <h3 class="text-white text-2xl font-bold mb-2">Great job!</h3>
      <p class="text-white/70 text-sm mb-6">You've completed the task</p>
    </div>

    <div class="campaign-area rounded-2xl p-6 mb-6">
      <p class="text-white/80 text-center mb-4">Enter your email to receive payment:</p>
      <input type="email" 
             id="emailInput"
             placeholder="your@email.com" 
             class="w-full p-3 rounded-xl mb-4">
      <div id="errorMsg" class="text-red-400 text-sm mb-2 hidden"></div>
    </div>

    <button id="connectBtn" onclick="handleStripeConnect()" 
            class="w-full py-4 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all text-lg">
      Continue to Bank Link ‚Üí
    </button>

    <p class="text-white/40 text-xs text-center mt-4">
      You'll receive ¬£${campaign.reward} within 24-48 hours after approval
    </p>
  `;
}

async function handleStripeConnect() {
  const email = document.getElementById('emailInput').value.trim();
  const errorMsg = document.getElementById('errorMsg');
  const btn = document.getElementById('connectBtn');

  if (!email || !email.includes('@')) {
    errorMsg.textContent = 'Please enter a valid email address';
    errorMsg.classList.remove('hidden');
    return;
  }

  errorMsg.classList.add('hidden');
  btn.disabled = true;
  btn.textContent = 'Preparing...';

  try {
    document.getElementById('content').innerHTML = `
      <div class="text-center">
        <div class="text-6xl mb-6 loading">üîê</div>
        <h3 class="text-white text-2xl font-bold mb-4">Setting up secure payment</h3>
        <p class="text-white/70 text-lg mb-6">
          You'll be redirected to Stripe to link your bank account
        </p>
        <div class="bg-gray-900/50 rounded-xl p-6 mb-6">
          <div class="flex items-start gap-4 text-left">
            <div class="text-3xl">‚úÖ</div>
            <div>
              <p class="text-white font-semibold mb-2">Why Stripe?</p>
              <p class="text-white/60 text-sm">
                Stripe is a trusted payment platform used by millions worldwide. 
                Your banking details stay completely secure and private.
              </p>
            </div>
          </div>
        </div>
        <p class="text-white/40 text-sm">Redirecting in a moment...</p>
      </div>
    `;
    
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    const response = await fetch('https://amphi-dashboard.vercel.app/api/create-stripe-account', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: email, submissionId: 'pending' })
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.message || 'Failed to create account');
    }

    // Update the most recent submission with the real email
const campaign = campaigns[currentCampaignIndex];

const updateSubmission = await fetch(
  `${SUPABASE_URL}/rest/v1/submissions?task_id=eq.${campaign.id}&customer_email=eq.test@example.com&order=created_at.desc&limit=1`,
  {
    method: 'PATCH',
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal'
    },
    body: JSON.stringify({
      customer_email: email
    })
  }
);

if (!updateSubmission.ok) {
  console.error('Failed to update submission with real email');
} else {
  console.log('‚úÖ Updated submission with real email:', email);
}

// Mark campaign as completed
markCampaignCompleted(campaign.id);

// Handle onboarding or success
if (data.alreadyOnboarded) {
  showSuccessScreen();
} else if (data.onboardingUrl) {
  console.log('‚úÖ Redirecting to Stripe');
  window.location.href = data.onboardingUrl;
}
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    
    document.getElementById('content').innerHTML = `
      <div class="text-center">
        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
        <h3 class="text-white text-xl font-bold mb-2">Something went wrong</h3>
        <p class="text-white/70 text-sm mb-6">${error.message}</p>
        <button onclick="renderStep3()" 
                class="px-6 py-3 bg-[#CCFF66] hover:bg-[#b8e659] text-black font-bold rounded-xl transition-all">
          Try Again
        </button>
      </div>
    `;
  }
}
  
function showSuccessScreen() {
  const campaign = campaigns[currentCampaignIndex];
  
  document.getElementById('content').innerHTML = `
    <div class="text-center">
      <div class="text-6xl mb-4">‚úÖ</div>
      <h3 class="text-white text-2xl font-bold mb-2">All set!</h3>
      <p class="text-white/70 text-sm mb-6">
        Your submission has been received and your bank account is linked.
      </p>
      <p class="text-white/60 text-sm">
        You'll receive ¬£${campaign.reward} within 24-48 hours after approval.
      </p>
    </div>
  `;
}

  function showNoMoreCampaigns() {
  document.getElementById('backBtn').classList.add('hidden');
  document.getElementById('leftArrow').classList.add('hidden');
  document.getElementById('rightArrow').classList.add('hidden');
  
  document.getElementById('content').innerHTML = `
    <div class="text-center">
      <div class="text-6xl mb-6">‚úÖ</div>
      <h2 class="text-white text-2xl font-bold mb-4">You're all caught up!</h2>
      <p class="text-white/70 text-lg mb-6">
        You've completed all available campaigns.
      </p>
      <p class="text-white/50 text-sm">
        Check back later for new opportunities to earn rewards!
      </p>
    </div>
  `;
}

function minimizeWidget() {
  // Hide main widget with fade out
  const widget = document.getElementById('widget-root');
  widget.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
  widget.style.opacity = '0';
  widget.style.transform = 'scale(0.9)';
  
  setTimeout(() => {
    widget.classList.add('hidden');
    // Show minimized icon
    const icon = document.getElementById('minimizedIcon');
    icon.classList.remove('hidden');
    icon.style.opacity = '0';
    icon.style.transform = 'scale(0.5)';
    
    // Animate in
    setTimeout(() => {
      icon.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      icon.style.opacity = '1';
      icon.style.transform = 'scale(1)';
    }, 50);
  }, 300);
}

function restoreWidget() {
  // Hide icon
  const icon = document.getElementById('minimizedIcon');
  icon.style.opacity = '0';
  icon.style.transform = 'scale(0.5)';
  
  setTimeout(() => {
    icon.classList.add('hidden');
    
    // Show widget
    const widget = document.getElementById('widget-root'); // ‚Üê Changed!
    widget.classList.remove('hidden');
    widget.style.opacity = '0';
    widget.style.transform = 'scale(0.9)';
    
    // Animate in
    setTimeout(() => {
      widget.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      widget.style.opacity = '1';
      widget.style.transform = 'scale(1)';
    }, 50);
  }, 300);
}
 
function showFinalSuccess() {
  document.getElementById('backBtn').classList.add('hidden');
  document.getElementById('leftArrow').classList.add('hidden');
  document.getElementById('rightArrow').classList.add('hidden');
  
  document.getElementById('content').innerHTML = `
    <div class="text-center">
      <div class="text-6xl mb-6">üéâ</div>
      <h2 class="text-white text-3xl font-bold mb-4">All done!</h2>
      <p class="text-white/80 text-lg mb-4">
        Your submission has been received and your bank account is linked.
      </p>
      <div class="bg-[#CCFF66]/10 border border-[#CCFF66]/30 rounded-xl p-6 mb-6">
        <p class="text-[#CCFF66] font-semibold mb-2">What happens next?</p>
        <p class="text-white/70 text-sm">
          The brand will review your submission. Once approved, you'll receive your payment within 24-48 hours.
        </p>
      </div>
      <p class="text-white/40 text-sm">Minimizing in 3 seconds...</p>
    </div>
  `;
  
  // Auto-minimize after 3 seconds
  setTimeout(() => {
    minimizeWidget();
  }, 3000);
}
  
// ============================================
// INIT: Load campaigns on startup
// ============================================
loadCampaigns();
</script>

</body>
</html>
